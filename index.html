<html>
<head>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<style type="text/css">
    td.task_complete {
        text-align: center;
    }
</style>
</head>
<body>
<table id="taskTable" border="1" cellspacing="0" cellpadding="2">
<form id="taskForm">
    <tr nobr>
        <td colspan="5">
            <strong>Create New Task:</strong>
            <input type="text" id="task_description" name="description" />
            <strong>Due:</strong>
            <input type="text" id="task_date" name="due_date" autocomplete="off" size="10" />
            <input type="submit" value=" Create Task " />
        </td>
    </tr>
</form>
    
<tbody id="taskHeader">
    <tr>
        <th>Delete</th>
        <th>Task ID</th>
        <th>Due Date</th>
        <th>Completed</th>
        <th align="left">Description</th>
    </tr>
</tbody>
<tbody id="tasks">
</tbody>
</table>

</body>
<script>
// Add an event so that if you click "Completed" it asks for confirmation then toggles the value
// Add events so if you click on date or description it brings up a modal and updates
// Add refresh event

api_url = "https://www.fsi.illinois.edu/demo/data.cfm";
api_key = "906fb0b13df5d4a8c2af20a87381368e";

const getTasks = () => {
    var tasks = $.post({
        url: api_url,
        contentType: "application/json",
        data: JSON.stringify({
            action: "getTasks",
		    apiKey: api_key,
	    }),
        dataType: "json",
    });
    return tasks.promise();
}

const createTask = (description, dueDate, completed) => {
    var createTask = $.post({
        url: api_url,
        contentType: "application/json",
        data: JSON.stringify({
            action: "createTask",
            task_description: description,
            due_date: dueDate,
            "completed": Number(!!completed),
		    apiKey: api_key,
	    }),
        dataType: "json",
    });
    return createTask.promise();
}

const updateTask = (taskId, description, dueDate, completed) => {
    var updateTask = $.post({
        url: api_url,
        contentType: "application/json",
        data: JSON.stringify({
            action: "updateTask",
            task_description: description,
            due_date: dueDate,
            "completed": Number(!!completed),
            task_id: taskId,
		    apiKey: api_key,
	    }),
        dataType: "text",
    });
    return updateTask.promise();
}

const deleteTask = (taskId) => {
    var deleteTask = $.post({
        url: api_url,
        contentType: "application/json",
        data: JSON.stringify({
            action: "deleteTask",
            task_id: taskId,
		    apiKey: api_key,
	    }),
        dataType: "text", // using JSON here gives a parseerror!! because the API returns nothing
    });
    return deleteTask.promise();
}

$(function() {
    $(document).tooltip();
    $("#task_date").datepicker();

    // Let's display the tasks when we first load the page!
    var tasks = getTasks();
    tasks.then(function(data) {
        $(function() {
            $.each(data, function(i, item) {
                var title = item.completed ? "Mark Incomplete" : "Mark Completed";
                var $tr = $(
                    `<tr id="row-${item.task_id}" data-task_id="${item.task_id}" data-description="${item.task_description}" data-due_date="${item.due_date}">`
                ).append(
                    $('<td align="center">').html(
                        '<input type="button" class="task_delete" value="Delete" />'
                    ),
                    $('<td align="center">').text(item.task_id),
                    $('<td align="center">').text(item.due_date),
                    $(`<td class="task_complete" title="${title}">`).text(item.completed?"Yes":"No"),
                    $('<td>').text(item.task_description),
                ).appendTo("#tasks");
            });
        });
    },
    function(status) {
        alert("Fail: " + JSON.stringify(status));
    });
});

$("#taskForm").submit(function(e) {
    e.preventDefault();

    var form = $(this);
    var description = $("#task_description").val();
    var dueDate = $("#task_date").val();
    var completed = false;
    var newTask = createTask(
        description,
        dueDate,
        completed,
    );
    newTask.then(function(data) {
        var $tr = $(
            `<tr id="row-${data.task_id}" data-task_id="${data.task_id}" data-description="${description}">  data-due_date="${item.due_date}">`
        ).append(
            $('<td align="center">').html('<input type="button" class="task_delete" value="Delete" />'),
            $('<td align="center">').text(data.task_id),
            $('<td align="center">').text(dueDate),
            $('<td class="task_complete">').text(completed?"Yes":"No"),
            $('<td>').text(description),
        ).appendTo("#tasks");
    },
    function(status) {
        alert("Fail: " + JSON.stringify(status));
    });
});

$("#tasks").on("click", ".task_delete", function(e) {
    e.preventDefault();
    var row = $(this).closest("tr");
    var task_id = row.data("task_id");
    var description = row.data("description");
    if (confirm(`Delete the task ${description} (id = ${task_id})?`)) {
        removeTask = deleteTask(task_id);
        removeTask.then(function(data) {
            $(`#row-${task_id}`).remove();
        },
        function(status) {
            alert("Fail: " + JSON.stringify(status));
        });
    }
}).on("click", ".task_complete", function(e) {
    e.preventDefault();
    var row = $(this).parent("tr");
    var task_id = row.data("task_id");
    var description = row.data("description");
    var due_date = row.data("due_date");

    var flag = $(this);

    if (flag.text() == "No") {
        if (confirm("Mark this task completed?")) {
            var completed = true;
            modifyTask = updateTask(task_id, description, due_date, completed);
            modifyTask.then(function(data) {
                flag.text("Yes");
            },
            function(status) {
                alert("Fail: " + JSON.stringify(status));
            });
        }
    } else {
        if (confirm("Mark this task incomplete?")) {
            var completed = false;
            modifyTask = updateTask(task_id, description, due_date, completed);
            modifyTask.then(function(data) {
                flag.text("No");
            },
            function(status) {
                alert("Fail: " + JSON.stringify(status));
            });
        }
    }
});
</script>
</html>
